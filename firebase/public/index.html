<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO MCP Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>
</head>
<body class="bg-gray-50">
    <div id="root" class="min-h-screen"></div>

    <script>
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456",
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const root = document.getElementById("root");

        async function renderApp() {
            const user = auth.currentUser;

            if (!user) {
                root.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <button id="login-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Sign in with Google
                        </button>
                    </div>
                `;
                document.getElementById("login-btn").addEventListener("click", () => {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    auth.signInWithPopup(provider);
                });
                return;
            }

            const keysSnapshot = await db.collection("users").doc(user.uid)
                .collection("api_keys").get();
            const keys = keysSnapshot.docs.map(doc => doc.data());

            root.innerHTML = `
                <div class="max-w-4xl mx-auto py-8 px-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h1 class="text-2xl font-bold mb-4">SEO MCP Dashboard</h1>
                        <p class="text-gray-600 mb-6">Welcome, ${user.email}!</p>

                        <div class="mb-6">
                            <button id="generate-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Generate New API Key</button>
                            <button id="logout-btn" class="ml-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Sign Out</button>
                        </div>

                        <h2 class="text-xl font-semibold mb-4">API Keys</h2>
                        <div class="space-y-4">
                            ${keys.length === 0 ? '<p class="text-gray-500">No API keys yet.</p>' : ''}
                            ${keys.map(key => `
                                <div class="border rounded p-4 flex justify-between items-center">
                                    <div>
                                        <p class="font-mono text-sm">${key.key}</p>
                                        <p class="text-gray-600 text-sm">Created: ${new Date(key.created_at.toDate()).toLocaleDateString()}</p>
                                        <p class="text-gray-600 text-sm">Expires: ${new Date(key.expires_at.toDate()).toLocaleDateString()}</p>
                                    </div>
                                    <button class="delete-btn px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700" data-id="${key.key.slice(0, 20)}">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById("generate-btn").addEventListener("click", async () => {
                const token = await user.getIdToken();
                const resp = await fetch("https://REGION-PROJECT_ID.cloudfunctions.net/generate_api_key", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${token}` },
                });
                const data = await resp.json();
                if (data.api_key) {
                    alert("API Key created: " + data.api_key + "\n\nKeep this safe!");
                    location.reload();
                }
            });

            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    const keyId = e.target.dataset.id;
                    const token = await user.getIdToken();
                    await fetch(`https://REGION-PROJECT_ID.cloudfunctions.net/delete_api_key?id=${keyId}`, {
                        method: "DELETE",
                        headers: { "Authorization": `Bearer ${token}` },
                    });
                    location.reload();
                });
            });

            document.getElementById("logout-btn").addEventListener("click", () => auth.signOut());
        }

        auth.onAuthStateChanged(renderApp);
    </script>
</body>
</html>
